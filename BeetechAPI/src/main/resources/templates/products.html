<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<head>
<meta charset="UTF-8">
<title>Danh sách sản phẩm</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<style type="text/css">
	#t-table tr {
		height: 50px;
	}
	
	#t-table tr td,
	#t-table tr th {
		padding: 0 8px;
	}
</style>
</head>
<body>
	<h1>Danh sách sản phẩm</h1>
	<h3> <a href="/list-cart">Giỏ hàng: <span th:utext="${totalQuantity}"></span> </a> </h3>
	<table id="t-table" border="1px">
		<tr>
			<th>STT</th>
			<th>Tên sản phẩm</th>
			<th>Hình ảnh</th>
			<th>Đơn giá</th>
			<th>Số lượng còn lại</th>
			<th>Xem chi tiết</th>
			<th>Thêm vào giỏ hàng</th>
		</tr>
		<tr th:each="product, index: ${products}">
			<td th:utext="${index.count}"></td>
			<td th:utext="${product.name}"></td>
			<td>
				<img alt="Ảnh sản phẩm" th:src="@{${product.photos}}" width="90px" height="113.3px">
			</td>
			<td th:utext="${product.price}"></td>
			<td th:utext="${product.quantity}"></td>
			<td> <a th:href="@{/public/details(id=${index.current.id})}">Xem chi tiết</a> </td>
			<td style="text-align: center"> 
				<!-- Cách 1 -->
				<!-- <form action="/cart" method="POST">
					<input style="display: none" type="text" name="id" th:value="${index.current.id}">
					<input type="submit" value="Thêm">
				</form> -->
				
				<!-- Cách 2 -->
				<span style="display: none;" class="t-product-id" th:text="${index.current.id}"></span>
				<button class="t-add-to-cart">Thêm</button>
				<span style="display: none" class="t-token" th:text="${session.token == null ? 'null' : session.token}"></span>
				
				<form style="display: none;" class="t-add-to-cart-clone" action="/"></form>
				
			</td>
		</tr>
	</table>
	
	<script type="text/javascript">
		$(document).ready(function () {
			// Thêm vào giỏ hàng:
			$('.t-add-to-cart').click(function (e) {
				let productId = Number($(e.target).prev().text());
				// Kiểm tra chuỗi token:
				// Nếu chưa đăng nhập (chưa có token) -> thêm vào list sản phẩm -> đẩy lên session.
				// Nếu đã đăng nhập -> thêm danh sách sản phẩm vào bảng cart database.
				let token = $(e.target).next().text();
				if( token === "null" ) {
					// Gọi đến API clone, post dữ liệu vào session:
					$.ajax({
	                    type: "POST",
	                    url: "http://localhost:8080/clone/cart",
	                    // async: false,
	                    data: JSON.stringify(productId),
	                    dataType: "json",
	                    contentType: "application/json",
	                    success: function (response) {
	                    	alert("Thêm thành công.");
	                    	window.location.reload();
	                    },
	                    error: function(reject) {
	                        alert("Không thành công.");
	                    }
	                });	
					
				}
				else {
					// Gọi đến API, post dữ liệu:
					$.ajax({
	                    type: "POST",
	                    url: "http://localhost:8080/cart",
	                    // async: false,
	                    data: JSON.stringify(productId),
	                    dataType: "json",
	                    contentType: "application/json",
	                    success: function (response) {
	                    	alert("Thêm thành công.");
	                    	window.location.reload();
	                    },
	                    error: function(reject) {
	                        alert("Bạn chưa đăng nhập.");
	                        $(".t-add-to-cart-clone").submit();
	                    }
	                });	
				}
					
			});
			
		}) 
	</script>

</body>
</html>