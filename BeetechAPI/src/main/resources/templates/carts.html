<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" >
<head>
<meta charset="UTF-8">
<title>Giỏ hàng</title>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<style type="text/css">
	#t-table td {
		padding: 0 16px;
	}
	
</style>
</head>
<body>
	<h1>Các sản phẩm trong giỏ hàng</h1>
	<span style="display: none" class="t-token" th:text="${session.token == null ? 'null' : session.token}"></span>
	<table id="t-table" border="1px">
		<thead>
			<tr>
				<th>STT</th>
				<th>Hình ảnh</th>
				<th>Tên sản phẩm</th>
				<th>Đơn giá</th>
				<th>Số lượng</th>
				<th>Thành tiền</th>
				<th>Chi tết</th>
				<th>Xóa sản phẩm</th>
			</tr>
		</thead>
		
		<tbody>
			<tr th:each="cartResponse, index: ${listProducts}">
				<td th:utext="${index.count}"></td>
				<td>
					<img alt="ảnh sản phẩm" th:src="@{${cartResponse.product.photos}}" width="90px" height="113.3px">
				</td>
				<td th:utext="${cartResponse.product.name}"></td>
				<td th:utext="${cartResponse.product.price}"></td>
				<td th:utext="${cartResponse.quantity}"></td>
				<td class="t-price" th:utext="${cartResponse.quantity * cartResponse.product.price}"></td>
				<td> <a th:href="@{/public/details(id=${index.current.product.id})}">Xem chi tiết</a> </td>
				<td style="text-align: center"> 
					<span class="cart-id" style="display: none" th:text="${cartResponse.id}"></span>
					<button class="t-delete">Xóa</button> 
					<span class="product-id" style="display: none" th:text="${index.current.product.id}"></span>
				</td>
			</tr>
		</tbody>
		
		<tfoot>
			<tr>
				<td colspan="8"> 
					<strong>Tổng tiền:</strong> 
					<strong class="t-total-price">15000000</strong>
				</td>
			</tr>
			<tr>
				<td colspan="8"> 
					<strong>Chọn phương thức thanh toán:</strong> <br>
					<input class="t-pay-offline" style="height:16px; width:16px;" type="radio" name="t-pay-method" checked/> Thanh toán khi nhận hàng. <br>
					<input class="t-pay-online" style="height:16px; width:16px;" type="radio" name="t-pay-method"/> Thanh toán qua ví điện tử. <br>
				</td>
			</tr>
			<tr>
				<td colspan="8"> 
					<strong>Thanh toán:</strong> 
					<button class="t-pay">Mua Ngay</button>
				</td>
			</tr>
			
		</tfoot>
		
	</table>
	
	
	<script type="text/javascript">
		$(document).ready(function() {
			// Tính tổng tiền:
			let prices = $(".t-price");
			let totalPrice = 0;
			for (let price of prices) {
				totalPrice += Number( $(price).text() );
			}
			$('.t-total-price').text(totalPrice);
			
			
			// Click xóa sản phẩm trong giỏ hàng:
			$('.t-delete').click(function(e) {
				let token = $('.t-token').text();
				if( token === 'null' ) {
					// Lấy product id:
					let productId = Number($(e.target).next().text());
					// Nếu chưa đăng nhập -> gọi đến API clone -> xóa trong session:
					$.ajax({
			            type: "DELETE",
			            url: `http://localhost:8080/clone/cart/${productId}`,
			            success: function (response) {
			                alert("Xóa thành công.");
			                window.location.reload();
			            }
			        });	
				}
				else {
					// Nếu đã đăng nhập -> gọi API xóa trong databse:
					// Gọi đến API, xóa sản phẩm trong giỏ hàng theo cartId:
					// Lấy cart id của sản phẩm:
					let cartId = Number($(e.target).prev().text());
					console.log("ahihi");
					$.ajax({
			            type: "DELETE",
			            url: `http://localhost:8080/cart/${cartId}`,
			            success: function (response) {
			                alert("Xóa thành công.");
			                window.location.reload();
			            }
			        });
				}
					
			});
			
			
			// Nhấn thanh toán:
			$('.t-pay').click(function () {
				let payMethod = $('input[name="t-pay-method"]:checked').attr('class');
				
				// Nếu thanh toán offline -> tạo đơn hàng:
				if( payMethod === 't-pay-offline' ) {
					
				}
					
				// Nếu thanh toán online -> kiểm tra liên kết ví điện tử 
				// Nếu chưa -> liên kết ví
				// Nếu đã liên kết -> thanh toán -> tạo đơn hàng
			});
			
		})
	
	</script>
</body>
</html>